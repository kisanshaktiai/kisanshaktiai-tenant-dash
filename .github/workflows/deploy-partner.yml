name: Deploy Partner (Hostinger)

on:
  push:
    branches: [ main, production ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # Node setup
      # --------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # --------------------------------------------------
      # Install & build
      # --------------------------------------------------
      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      # --------------------------------------------------
      # SSH key setup (NO remote shell usage)
      # --------------------------------------------------
      - name: Setup SSH key
        run: |
          set -e

          if [ -z "${{ secrets.PARTNER_SFTP_KEY_B64 }}" ]; then
            echo "âŒ PARTNER_SFTP_KEY_B64 is missing"
            exit 1
          fi

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.PARTNER_SFTP_KEY_B64 }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # --------------------------------------------------
      # Deploy via SFTP (forced-command SAFE)
      # --------------------------------------------------
      - name: Deploy via SFTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          protocol: sftp
          server: ${{ secrets.PARTNER_SFTP_HOST }}
          port: ${{ secrets.PARTNER_SFTP_PORT }}
          username: ${{ secrets.PARTNER_SFTP_USER }}
          password: ""   # IMPORTANT: empty when using SSH key
          local-dir: ./dist/
          server-dir: ${{ secrets.PARTNER_HOST_REMOTE_DIR }}/
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/*.md

      # --------------------------------------------------
      # Success message
      # --------------------------------------------------
      - name: Deployment success
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Partner app deployed successfully"
          echo "ğŸ“ Remote directory: ${{ secrets.PARTNER_HOST_REMOTE_DIR }}"
          echo "ğŸŒ Subdomain: partner.kisanshaktiai.in"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
